#### [메이플스토리 PC] 웹 백엔드 엔지니어 과제

---
## 이벤트 보상 시스템 (NestJS MSA)

## 시스템 아키텍처

3개의 서비스로 구성했습니다.
1.  **Gateway Server**:
    * 모든 API 요청의 진입점
    * 요청을 적절한 백엔드 서비스로 라우팅.
2.  **Auth Server**:
    * 사용자 정보 관리 (가입, 로그인, 정보 확인).
    * 역할(Role) 기반 접근 제어를 위한 사용자 역할 관리.
    * 로그인 성공 시 JWT 발급 
    * Refresh 로직은 배제, Refresh 은 클라이언트 책임이 늘어나는데 Client 미존재함.
    * 역할 (4개):  
        * `USER`: 보상 요청 가능. 자신의 요청 내역 조회.
        * `OPERATOR`: 이벤트 및 보상 등록/수정/조회. 전체 유저 요청 기록 조회 및 처리.
          * (쓰기 권한에는 읽기 권한 기본 포함 가정) 
        * `AUDITOR`: 지급 내역(보상 요청 기록) 조회만 가능.
        * `ADMIN`: 모든 기능 접근 가능. 사용자 역할 관리, 서비스 등록 관리.
3.  **Event Server**:
    * 이벤트 생성, 조건 정의, 기간 설정, 상태 관리.
    * 이벤트에 따른 보상(포인트, 아이템, 쿠폰 등) 정의 및 수량 관리.
    * 사용자의 보상 요청 처리 (조건 검증, 중복 방지).
    * 보상 지급 요청 상태 저장 및 이력 관리.
    * (선택 사항) 필터 기능 통해 이벤트별, 상태별 등 사용자 진행 상황 추적.


모든 요청은 `service-registry` 모듈에 사전 구조된 형태로 `/auth-service...`, `event-service...` 형태로 Gateway를 통해 각 선별된 서비스로 전달됩니다.
Gateway는 인증된 사용자의 ID (`X-User-Id`)와 역할 (`X-User-Roles`)을 헤더에 담아 내부 서비스로 전달합니다.


## 구현 중 겪은 고민 및 설계 결정 사항

* **인증 및 인가 전략**:
    * **Gateway에서의 중앙 처리**: Gateway에서 모든 요청에 대해 JWT 유효성을 검증하고, 토큰에 담긴 사용자 역할을 기반으로 각 엔드포인트 접근 권한을 확인합니다.
    * **각각의 서비스로 사용자 정보 전달**: Gateway는 인증된 사용자의 ID와 역할을 커스텀 헤더(`X-User-Id`, `X-User-Roles`)에 담아 백엔드 서비스로 전달합니다. 백엔드 서비스는 이 헤더 정보를 신뢰하고 로직을 수행합니다.
* **서비스 디스커버리 및 라우팅 설정**:
    * **정적 설정 기반의 동적 확장 구조**: 서비스 디스커버리 도구(Eureka 등)를 사용할 수 없는 환경을 가정하여, Gateway Server의 `src/config/service-registry.config.ts` 파일에 서비스 정보를 정적으로 정의했습니다.
    * **확장성 고려**: 하지만 단순히 하드코딩하는 대신, `ServiceRegistryService` 클래스와 설정 파일(`service-registry.config.ts`) 구조를 통해 서비스 정보를 관리하도록 설계했습니다. 이렇게 설계한 이유는 향후 각 백엔드 서비스가 시작 시 Gateway의 특정 API 엔드포인트로 자신의 정보(URL, 권한 규칙 등)를 동적으로 등록하고, Gateway가 이 정보를 기반으로 라우팅 테이블을 관리하며 주기적인 Health Check를 수행하는 방식으로 쉽게 확장할 수 있도록 하기 위함입니다. 즉, 현재는 정적 데이터를 사용하지만, 
  동적 서비스 등록 및 관리를 위한 기반 구조를 염두하여 설계했습니다.
* **에러 핸들링**: DTO를 통한 요청 유효성 검사를 수행하도록 했습니다. 각 서비스 및 Gateway에서 발생하는 예외에 대해 적절한 HTTP 응답코드와 적절한오류 메시지를 반환하도록 노력했습니다.
* **헬스체크**: 유동적이지 않은 서비스 구조로 HealthCheck 를 제외했지만 원래는 Gateway Server가 주기적으로 등록된 백엔드 서비스의 상태를 확인하여, `UNHEALTHY`로 판단된 서비스로는 요청을 라우팅하지 않도록 하는 기능을 포함하고자 했습니다. 각 백엔드 서비스는 간단한 `/health` 엔드포인트를 제공하여 자신의 상태를 알립니다.
* **단일 보상 요청 방식 채택 이유**:
  * 개발 중 이벤트에 연결된 모든 보상을 한 번의 요청으로 지급하는 방안도 고려했는데, 최종적으로는 사용자가 `eventId`와 함께 연결된 특정 `rewardId`를 명시하여 개별 보상을 요청하는 방식을 채택했습니다.
  * 메이플스토리에서 사용자가 여러 보상 항목 중 특정 항목을 선택하거나, 순차적으로 개별 보상을 수령하는 방식이 일반적이라는 점과 추후 일괄 처리 로직으로도 유연하게 대처될거같아 개별 보상으로 결정햇습니다.
  * 만약 일괄지급 기능이 필요하다면, 현재의 단일 보상 요청 API를 여러 번 호출하거나, 별도의 일괄 지급 API 엔드포인트를 추가로 구성하는 방식으로 확장할 수 있습니다.


### 애플리케이션 실행

* **명령어 실행 위치**: 프로젝트 루트 디렉토리 (`docker-compose.yml` 파일이 있는 위치)
* **명령어 1 (이미지 빌드 - 필요한 경우)**:
  ```bash
  docker-compose build --no-cache
  ```
    * `--no-cache` 옵션은 캐시를 사용하지 않고 이미지를 새로 빌드합니다.


* **명령어 2 (애플리케이션 시작)**:
  ```bash
  docker-compose up -d
  ```
    * `-d` 옵션은 백그라운드에서 컨테이너 실행합니다, 멀티 컨테이너라 넣는게 좋을듯해요

### 애플리케이션 중지

* **명령어 실행 위치**: 프로젝트 루트 디렉토리 (`docker-compose.yml` 파일이 있는 위치)
* **명령어**:
  ```bash
  docker-compose down
  ```
    * 데이터 볼륨까지 함께 삭제하려면 `-v` 옵션을 추가해주세요.